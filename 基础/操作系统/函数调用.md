# 前言

​	函数调用的一部分内容已经在上一篇文章分享过，这篇文章将接着继续讲述在函数调用过程中的一部分细节。



# 回顾

虚拟地址空间

注意一点：虚拟地址空间中的用户栈空间是向下分配的，也就是说栈底在上，栈顶在下。

![1663337779462](D:\文档\学习笔记\基础\操作系统\函数调用和局部变量存储.assets\1663337779462.png)

其中，我们本次的关注点在于用户栈，在函数调用过程中，方法的返回地址会存储在栈中，不仅如此，当需要的时候，栈中还会存储一些其他信息，比如寄存器中的值，局部变量，还可以用于函数调用的参数传递。每个正在执行的函数所分配的栈空间内存，被称为**栈帧**。

![1663340530115](D:\文档\学习笔记\基础\操作系统\函数调用和局部变量存储.assets\1663340530115.png)



# 数据传送

​	当我们的程序中调用一个函数的时候，除了要将控制传递到这个函数（即修改pc寄存器的值，让CPU执行函数中的指令）之外，还可能需要传递一些参数，而函数返回之时还有可能带有返回值，那么这些数据是如何传递的呢？



## 通过寄存器传递数据

​	百度百科：寄存器是[CPU](https://baike.baidu.com/item/CPU/120556?fromModule=lemma_inlink)内部用来存放数据的一些小型存储区域，用来暂时存放参与运算的数据和运算结果。

​	在CPU中，有一种专门的硬件结构用于暂存数据，包括运算所需要的操作数和运算的中间结果，这种硬件结构就是寄存器。

​	通常情况下，我们调用函数时所需要传递的参数是存放在这些寄存器当中的，在x86-64指令体系（中央处理器指令集架构，也就是硬件运行的指令集）中，可以通过寄存器最多传递6个整型（例如整数和指针）参数。

![image-20221010165237087](D:\文档\学习笔记\基础\操作系统\函数调用和局部变量存储.assets\image-20221010165237087.png)

​	如图所示，也就是说，调用函数时，程序按照规定将参数存储到这些寄存器中，执行到另一个函数的函数体里面时，则按照规定取出对应参数来使用。



​	比如下面这个简单的程序，在main函数中调用了sum函数，并且传递了两个参数，在调用的过程中发生了什么呢？

~~~c
#include<stdio.h>
int sum(int x,int y);

void main()
{
    int res = sum(5,10);
    printf("result = %d \n",res);
}

int sum(int x,int y)
{
    return x+y;
}
~~~

* 首先，程序会将sum函数的返回地址（main方法中下一条要执行指令的地址）压入用户栈中，并且更改PC寄存器中的值为sum函数第一条指令的地址。
* 于此同时，将第一个参数5放入寄存器%rdi中，第二个参数10放入寄存器%rsi中。
* CPU继续取指执行，取出PC寄存器所指的指令继续执行，这时也就进入了sum函数中执行，在sum函数中使用参数时，就可以从%rdi寄存器和%rsi寄存器中取出前面部分存入的数据，也就是5和10，取出两个参数进行相加后，将结果存入到%rax寄存器中。
* sum函数执行完成之前的最后一个操作就是：从栈中取出返回地址，并将pc寄存器中的值设置为返回地址的值，这样CPU接着取指执行就会回到main函数中执行。
* 回到main函数执行后，程序继续执行，将会从%rax寄存器中取出返回值并使用。



## 通过栈传递数据

​	我们可以看到，在x86-64指令体系下，用于传递参数的寄存器只有6个，如果函数的参数多于6个，该怎么办呢？

​	这个时候，栈内存就再一次起到作用了，多于6个的参数会在栈上分配内存。



​	例如下面这个函数：

~~~c
#include<stdio.h>

int sum(int x1,int x2,int x3,int x4,int x5,int x6,int x7,int x8);

void main()
{
    int res = sum(1,2,3,4,5,6,7,8);
    printf("res = %d \n",res);
}

int sum(int x1,int x2,int x3,int x4,int x5,int x6,int x7,int x8)
{
    return x1+x2+x3+x4+x5+x6+x7+x8;
}
~~~

​	sum函数一共有8个参数，main函数调用sum函数时，前6个参数分别存储在对应的寄存器中，后2个参数按照从右到左的顺序依次存放到栈中。

![image-20221013195602516](D:\文档\学习笔记\基础\操作系统\函数调用.assets\image-20221013195602516.png)

​	如图所示，参数8先放到栈中，然后再放入参数7，最后进入sum函数执行时，放入返回地址。这样，在sum函数执行时就可以通过栈顶指针来获得函数的参数，顺利往下执行。
